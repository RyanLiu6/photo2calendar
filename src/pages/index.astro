---
import BaseLayout from "@/layouts/BaseLayout.astro";
import UploadHandler from "@/components/UploadHandler";
import { loadSampleOCRResults } from "@/utils/loadSampleData";

const samples = loadSampleOCRResults();
---

<BaseLayout>
  <section class="flex flex-col justify-center items-center pb-8">
    <h1 class="font-bold text-3xl pb-4">Photo2Calendar</h1>
    <p class="text-sm">Convert your work schedule photos into calendar events instantly</p>
  </section>

  <section class="bg-white shadow rounded-lg p-6 dark:bg-slate-700">
    <UploadHandler client:load />

    {samples.length > 0 && (
      <div class="mt-6 border-t pt-4">
        <h2 class="text-lg font-semibold mb-3">Test with Sample Data</h2>
        <div class="flex gap-3">
          {samples.map((sample, index) => (
            <button
              class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm"
              onclick={`processSample(${index})`}
            >
              Sample {index + 1}
              <span class="text-xs block text-blue-100">
                {new Date(sample.metadata.timestamp).toLocaleDateString()}
              </span>
            </button>
          ))}
        </div>
      </div>
    )}

    <div class="mt-4">
      <h2 class="text-lg font-semibold">How it works</h2>
      <ol class="list-decimal list-inside space-y-2 text-sm">
        <li>Upload a photo of your work schedule</li>
        <li>Our system will automatically extract the schedule information</li>
        <li>Review the extracted schedule</li>
        <li>Download the schedule as an ICS file to import into your calendar</li>
      </ol>
    </div>
  </section>
</BaseLayout>

<script>
async function processSample(index) {
  try {
    const response = await fetch(`/api/sample/${index}`);
    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'Failed to process sample');
    }

    window.location.href = `/${data.scheduleId}`;
  } catch (error) {
    console.error('Error processing sample:', error);
    alert('Failed to process sample schedule');
  }
}

// Make the function available globally
window.processSample = processSample;
</script>
